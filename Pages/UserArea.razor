@page "/users"
@attribute [Authorize]
@inject IHttpClientFactory HttpFactory
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>User Area</h3>

<UserForm User="newUser" OnSubmit="HandleSubmit" />

<div class="tw-m-4">
    <h4>Users</h4>
    @if (users != null)
    {
        <table class="tw-w-full tw-border-collapse tw-border tw-border-gray-300">
            <thead>
                <tr class="tw-bg-gray-100">
                    <th class="tw-border tw-p-2">Name</th>
                    <th class="tw-border tw-p-2">Email</th>
                    <th class="tw-border tw-p-2">Phone</th>
                    <th class="tw-border tw-p-2">Role</th>
                    <th class="tw-border tw-p-2">Created</th>
                    <th class="tw-border tw-p-2">Updated</th>
                    <th class="tw-border tw-p-2">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in users)
                {
                    <tr>
                        <td class="tw-border tw-p-2">@user.Name</td>
                        <td class="tw-border tw-p-2">@user.Email</td>
                        <td class="tw-border tw-p-2">@user.PhoneNo</td>
                        <td class="tw-border tw-p-2">@user.Role</td>
                        <td class="tw-border tw-p-2">@ToSAST(user.CreatedDate).ToString("g")</td>
                        <td class="tw-border tw-p-2">@ToSAST(user.UpdatedDate).ToString("g")</td>
                        <td class="tw-border tw-p-2">
                            <button @onclick="() => EditUser(user)" class="tw-bg-yellow-500 tw-text-white tw-p-1 tw-rounded tw-mr-2">Edit</button>
                            <button @onclick="() => DeleteUser(user.Id)" class="tw-bg-red-500 tw-text-white tw-p-1 tw-rounded">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>Loading users...</p>
    }
</div>

@if (editingUser != null)
{
    <UserForm 
        User="editingUser" 
        Title="Edit User" 
        SubmitButtonText="Save" 
        SubmitButtonColor="green" 
        ShowCancelButton="true" 
        OnSubmit="HandleEditSubmit" 
        OnCancel="CancelEdit" />
}

<AccessDeniedModal IsVisible="showAccessDeniedModal" OnClose="CloseModal" />

@code {
    private AppUser newUser = new();
    private List<AppUser> users;
    private AppUser editingUser;
    private HttpClient _httpClient => HttpFactory.CreateClient("AppUsersApi");
    private bool showAccessDeniedModal = false;
    private static readonly TimeZoneInfo SAST = TimeZoneInfo.FindSystemTimeZoneById(
        OperatingSystem.IsWindows() ? "South Africa Standard Time" : "Africa/Johannesburg");

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            var response = await _httpClient.GetAsync("api/appusers");
            await JS.InvokeVoidAsync("console.log", $"Load Status: {response.StatusCode}");
            var content = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("console.log", $"Load Response: {content}");
            if (response.IsSuccessStatusCode)
            {
                users = await response.Content.ReadFromJsonAsync<List<AppUser>>();
                await JS.InvokeVoidAsync("console.log", $"Loaded {users.Count} users");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                Navigation.NavigateTo("/Identity/Account/Login");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.log", $"Error loading users: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            var response = await _httpClient.PostAsJsonAsync("api/appusers", newUser);
            await JS.InvokeVoidAsync("console.log", $"Post Status: {response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                newUser = new AppUser();
                await LoadUsers();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden || response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                showAccessDeniedModal = true;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.log", $"Error creating user: {ex.Message}");
        }
    }

    private void EditUser(AppUser user)
    {
        editingUser = new AppUser
        {
            Id = user.Id,
            Name = user.Name,
            Email = user.Email,
            PhoneNo = user.PhoneNo,
            Role = user.Role,
            CreatedDate = user.CreatedDate,
            UpdatedDate = user.UpdatedDate
        };
    }

    private async Task HandleEditSubmit()
    {
        try
        {
            var response = await _httpClient.PutAsJsonAsync($"api/appusers/{editingUser.Id}", editingUser);
            await JS.InvokeVoidAsync("console.log", $"Put Status: {response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                editingUser = null;
                await LoadUsers();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden || response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                showAccessDeniedModal = true;
                await JS.InvokeVoidAsync("console.log", $"Modal set to: {showAccessDeniedModal}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.log", $"Error updating user: {ex.Message}");
        }
    }

    private async Task DeleteUser(int id)
    {
        try
        {
            var response = await _httpClient.DeleteAsync($"api/appusers/{id}");
            await JS.InvokeVoidAsync("console.log", $"Delete Status: {response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                await LoadUsers();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden || response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                showAccessDeniedModal = true;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.log", $"Error deleting user: {ex.Message}");
        }
    }

    private Task CloseModal()
    {
        showAccessDeniedModal = false;
        return Task.CompletedTask; // Return Task for async compatibility
    }

    private Task CancelEdit()
    {
        editingUser = null;
        return Task.CompletedTask;
    }

    private DateTime ToSAST(DateTime utcDate)
    {
        return TimeZoneInfo.ConvertTimeFromUtc(utcDate, SAST);
    }
}